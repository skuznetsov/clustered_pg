CREATE EXTENSION clustered_pg;
SELECT public.version();
      version       
--------------------
 clustered_pg 0.1.0
(1 row)

CREATE TABLE clustered_pg_tableam_smoke(i int) USING clustered_heap;
CREATE INDEX clustered_pg_tableam_smoke_idx ON clustered_pg_tableam_smoke (i);
INSERT INTO clustered_pg_tableam_smoke(i) VALUES (1), (3), (7), (9);
SELECT am.amname AS tableam_name
FROM pg_class c
JOIN pg_am am ON c.relam = am.oid
WHERE c.relname = 'clustered_pg_tableam_smoke';
  tableam_name  
----------------
 clustered_heap
(1 row)

SELECT array_agg(i ORDER BY i) AS tableam_values FROM clustered_pg_tableam_smoke;
 tableam_values 
----------------
 {1,3,7,9}
(1 row)

SELECT count(*) AS tableam_filter_count
FROM clustered_pg_tableam_smoke
WHERE i IN (3,9);
 tableam_filter_count 
----------------------
                    2
(1 row)

UPDATE clustered_pg_tableam_smoke
SET i = i + 1
WHERE i = 3;
SELECT count(*) AS tableam_rows_after_update FROM clustered_pg_tableam_smoke;
 tableam_rows_after_update 
---------------------------
                         4
(1 row)

ANALYZE clustered_pg_tableam_smoke;
VACUUM clustered_pg_tableam_smoke;
DELETE FROM clustered_pg_tableam_smoke WHERE i > 4;
SELECT count(*) AS tableam_rows_after_delete FROM clustered_pg_tableam_smoke;
 tableam_rows_after_delete 
---------------------------
                         2
(1 row)

TRUNCATE clustered_pg_tableam_smoke;
SELECT count(*) AS tableam_rows_after_truncate FROM clustered_pg_tableam_smoke;
 tableam_rows_after_truncate 
-----------------------------
                           0
(1 row)

DROP TABLE clustered_pg_tableam_smoke;
CREATE TABLE clustered_pg_tableam_segmented(i bigint) USING clustered_heap;
CREATE INDEX clustered_pg_tableam_segmented_idx
	ON clustered_pg_tableam_segmented USING clustered_pk_index (i)
	WITH (split_threshold=16, target_fillfactor=75, auto_repack_interval=30.0);
INSERT INTO clustered_pg_tableam_segmented(i)
SELECT generate_series(1,12);
SELECT count(*) AS tableam_segment_rows_before_truncate
FROM segment_map_stats('clustered_pg_tableam_segmented'::regclass::oid);
 tableam_segment_rows_before_truncate 
--------------------------------------
                                 1
(1 row)

TRUNCATE clustered_pg_tableam_segmented;
SELECT count(*) AS tableam_segment_rows_after_truncate
FROM segment_map_stats('clustered_pg_tableam_segmented'::regclass::oid);
 tableam_segment_rows_after_truncate 
-------------------------------------
                                  0
(1 row)

DROP TABLE clustered_pg_tableam_segmented;
SELECT locator_to_hex(locator_pack(4,7)) as packed_hex;
            packed_hex             
-----------------------------------
 0000000000000004:0000000000000007
(1 row)

SELECT locator_pack_int8(12345) = locator_pack(0,12345) as pack_int8_matches_pair;
 pack_int8_matches_pair 
------------------------
 t
(1 row)

SELECT locator_major(locator_pack_int8(12345)) as major_part,
       locator_minor(locator_pack_int8(12345)) as minor_part;
 major_part | minor_part 
------------+------------
          0 |      12345
(1 row)

SELECT locator_cmp(locator_pack(1, 10), locator_pack(1, 11)) AS cmp_1;
 cmp_1 
-------
    -1
(1 row)

SELECT locator_cmp(locator_pack(2, 1), locator_pack(1, 1000000)) AS cmp_2;
 cmp_2 
-------
     1
(1 row)

SELECT locator_to_hex(locator_advance_major(locator_pack(4,7), 3)) AS advanced_hex;
           advanced_hex            
-----------------------------------
 0000000000000007:0000000000000007
(1 row)

SELECT locator_to_hex(locator_next_minor(locator_pack(4,7), 10)) AS next_minor_hex;
          next_minor_hex           
-----------------------------------
 0000000000000004:0000000000000011
(1 row)

CREATE TEMP TABLE clustered_pg_fixture(id int);
SELECT segment_map_touch('clustered_pg_fixture'::regclass::oid, 4, 1, 100, 128, 85, 60.0) AS touched_count;
 touched_count 
---------------
             1
(1 row)

SELECT * FROM segment_map_stats('clustered_pg_fixture'::regclass::oid) ORDER BY major_key;
 major_key | minor_from | minor_to | row_count | split_generation 
-----------+------------+----------+-----------+------------------
         4 |          1 |      100 |         0 |                0
(1 row)

SELECT locator_to_hex(segment_map_allocate_locator('clustered_pg_fixture'::regclass::oid, 1, 1)) AS alloc_hex_1;
            alloc_hex_1            
-----------------------------------
 0000000000000004:0000000000000001
(1 row)

SELECT locator_to_hex(segment_map_allocate_locator('clustered_pg_fixture'::regclass::oid, 2, 1)) AS alloc_hex_2;
            alloc_hex_2            
-----------------------------------
 0000000000000004:0000000000000002
(1 row)

SELECT locator_to_hex(segment_map_allocate_locator('clustered_pg_fixture'::regclass::oid, 3, 1, 2)) AS alloc_hex_3;
            alloc_hex_3            
-----------------------------------
 0000000000000003:0000000000000003
(1 row)

SELECT locator_to_hex(segment_map_allocate_locator('clustered_pg_fixture'::regclass::oid, 4, 1, 2)) AS alloc_hex_4;
            alloc_hex_4            
-----------------------------------
 0000000000000004:0000000000000004
(1 row)

SELECT locator_to_hex(segment_map_allocate_locator('clustered_pg_fixture'::regclass::oid, 10, 1, 2)) AS alloc_hex_5;
            alloc_hex_5            
-----------------------------------
 0000000000000004:000000000000000A
(1 row)

SELECT locator_to_hex(segment_map_allocate_locator('clustered_pg_fixture'::regclass::oid, 10, 1, 2)) AS alloc_hex_6;
            alloc_hex_6            
-----------------------------------
 0000000000000004:000000000000000A
(1 row)

SELECT locator_to_hex(segment_map_allocate_locator_regclass('clustered_pg_fixture', 11, 1, 2)) AS alloc_hex_7;
            alloc_hex_7            
-----------------------------------
 0000000000000004:000000000000000B
(1 row)

SELECT locator_to_hex(segment_map_next_locator('clustered_pg_fixture', 12, 1, 2)) AS alloc_hex_8;
            alloc_hex_8            
-----------------------------------
 0000000000000004:000000000000000C
(1 row)

CREATE TABLE clustered_pg_gap_allocator(id int);
SELECT locator_to_hex(segment_map_allocate_locator('clustered_pg_gap_allocator'::regclass::oid, 10, 1, 1, 100)) AS gap_alloc_10;
           gap_alloc_10           
-----------------------------------
 0000000000000000:000000000000000A
(1 row)

SELECT locator_to_hex(segment_map_allocate_locator('clustered_pg_gap_allocator'::regclass::oid, 30, 1, 1, 100)) AS gap_alloc_30;
           gap_alloc_30           
-----------------------------------
 0000000000000001:000000000000001E
(1 row)

SELECT locator_to_hex(segment_map_allocate_locator('clustered_pg_gap_allocator'::regclass::oid, 20, 1, 1, 100)) AS gap_alloc_20;
           gap_alloc_20           
-----------------------------------
 0000000000000002:0000000000000014
(1 row)

SELECT COUNT(*) AS gap_allocator_segment_count
FROM segment_map_stats('clustered_pg_gap_allocator'::regclass::oid);
 gap_allocator_segment_count 
---------------------------
                        3
(1 row)

SELECT array_agg(major_key ORDER BY major_key) AS gap_allocator_majors
FROM segment_map_stats('clustered_pg_gap_allocator'::regclass::oid);
         gap_allocator_majors         
--------------------------------------
 {0,1,2}
(1 row)

SELECT locator_major(locator_pack(0,10)) AS major_check,
       locator_minor(locator_pack(0,10)) AS minor_check;
 major_check | minor_check 
-------------+-------------
           0 |          10
(1 row)

CREATE TABLE clustered_pk_int8_table(id bigint);
CREATE INDEX clustered_pk_int8_table_idx ON clustered_pk_int8_table USING clustered_pk_index (id);
DROP TABLE clustered_pk_int8_table;
CREATE TABLE clustered_pk_int8_build_table(id bigint);
INSERT INTO clustered_pk_int8_build_table(id)
SELECT generate_series(1,18);
CREATE INDEX clustered_pk_int8_build_table_idx
	ON clustered_pk_int8_build_table USING clustered_pk_index (id)
		WITH (split_threshold=16, target_fillfactor=75, auto_repack_interval=30.0);
SELECT * FROM segment_map_stats('clustered_pk_int8_build_table'::regclass::oid) ORDER BY major_key;
 major_key | minor_from | minor_to | row_count | split_generation 
-----------+------------+----------+-----------+------------------
         0 |          1 |       12 |        12 |                1
         1 |         13 |       18 |         6 |                1
(2 rows)

DROP TABLE clustered_pk_int8_build_table;
CREATE TABLE clustered_pk_int8_table_opts(id bigint);
CREATE INDEX clustered_pk_int8_table_opts_idx
	ON clustered_pk_int8_table_opts USING clustered_pk_index (id)
		WITH (split_threshold=16, target_fillfactor=75, auto_repack_interval=30.0);
INSERT INTO clustered_pk_int8_table_opts(id)
SELECT generate_series(1,18);
SELECT * FROM segment_map_stats('clustered_pk_int8_table_opts'::regclass::oid) ORDER BY major_key;
 major_key | minor_from | minor_to | row_count | split_generation 
-----------+------------+----------+-----------+------------------
         0 |          1 |       12 |        12 |                0
         1 |         13 |       18 |         6 |                0
(2 rows)

DROP TABLE clustered_pk_int8_table_opts;
CREATE TABLE clustered_pk_int8_vacuum_table(id bigint);
INSERT INTO clustered_pk_int8_vacuum_table(id)
SELECT generate_series(1,18);
CREATE INDEX clustered_pk_int8_vacuum_table_idx
	ON clustered_pk_int8_vacuum_table USING clustered_pk_index (id)
		WITH (split_threshold=16, target_fillfactor=75, auto_repack_interval=30.0);
SELECT * FROM segment_map_stats('clustered_pk_int8_vacuum_table'::regclass::oid) ORDER BY major_key;
 major_key | minor_from | minor_to | row_count | split_generation 
-----------+------------+----------+-----------+------------------
         0 |          1 |       12 |        12 |                1
         1 |         13 |       18 |         6 |                1
(2 rows)

SELECT segment_map_count_repack_due('clustered_pk_int8_vacuum_table'::regclass::oid, 3600.0::double precision) AS due_repack_before_vacuum;
 due_repack_before_vacuum 
--------------------------
                        0
(1 row)

DELETE FROM clustered_pk_int8_vacuum_table WHERE id BETWEEN 1 AND 4;
VACUUM clustered_pk_int8_vacuum_table;
SELECT * FROM segment_map_stats('clustered_pk_int8_vacuum_table'::regclass::oid) ORDER BY major_key;
 major_key | minor_from | minor_to | row_count | split_generation 
-----------+------------+----------+-----------+------------------
         0 |          1 |       12 |        12 |                2
         1 |         13 |       18 |         6 |                2
(2 rows)

SELECT segment_map_count_repack_due('clustered_pk_int8_vacuum_table'::regclass::oid, 3600.0::double precision) AS due_repack_after_vacuum;
 due_repack_after_vacuum 
-------------------------
                       0
(1 row)

DROP TABLE clustered_pk_int8_vacuum_table;
CREATE TABLE clustered_pk_int8_rebuild_table(id bigint);
INSERT INTO clustered_pk_int8_rebuild_table(id)
SELECT generate_series(1,18);
CREATE INDEX clustered_pk_int8_rebuild_table_idx
	ON clustered_pk_int8_rebuild_table USING clustered_pk_index (id)
		WITH (split_threshold=16, target_fillfactor=75, auto_repack_interval=30.0);
DELETE FROM clustered_pk_int8_rebuild_table WHERE id BETWEEN 1 AND 4;
SELECT segment_map_count_repack_due('clustered_pk_int8_rebuild_table'::regclass::oid, 3600.0::double precision) AS due_repack_before_manual_rebuild;
 due_repack_before_manual_rebuild 
----------------------------------
                                0
(1 row)

SELECT segment_map_rebuild_from_index('clustered_pk_int8_rebuild_table_idx'::regclass, 1, 16, 75, 30.0::double precision) AS rebuilt_rows;
 rebuilt_rows 
--------------
           14
(1 row)

SELECT * FROM segment_map_stats('clustered_pk_int8_rebuild_table'::regclass::oid) ORDER BY major_key;
 major_key | minor_from | minor_to | row_count | split_generation 
-----------+------------+----------+-----------+------------------
         0 |          5 |       16 |        12 |                2
         1 |         17 |       18 |         2 |                2
(2 rows)

DROP TABLE clustered_pk_int8_rebuild_table;
CREATE TABLE clustered_pg_perf_smoke(locator bytea);
INSERT INTO clustered_pg_perf_smoke(locator)
SELECT segment_map_allocate_locator('clustered_pg_perf_smoke'::regclass::oid, g, 1, 100, 100)
FROM generate_series(1,10000) g;
SELECT count(*) AS perf_smoke_rows FROM clustered_pg_perf_smoke;
 perf_smoke_rows 
-----------------
           10000
(1 row)

SELECT count(*) AS perf_smoke_segment_count,
       sum(row_count) AS perf_smoke_segment_rows,
       max(major_key) AS perf_smoke_max_major
FROM segment_map_stats('clustered_pg_perf_smoke'::regclass::oid);
 perf_smoke_segment_count | perf_smoke_segment_rows | perf_smoke_max_major 
--------------------------+-------------------------+----------------------
                      100 |                   10000 |                   99
(1 row)

DROP TABLE clustered_pg_perf_smoke;
CREATE TABLE clustered_pg_fillfactor_bounds(locator bytea);
INSERT INTO clustered_pg_fillfactor_bounds(locator)
SELECT segment_map_allocate_locator('clustered_pg_fillfactor_bounds'::regclass::oid, g, 1, 4, 100)
FROM generate_series(1,18) g;
SELECT * FROM segment_map_stats('clustered_pg_fillfactor_bounds'::regclass::oid) ORDER BY major_key;
 major_key | minor_from | minor_to | row_count | split_generation 
-----------+------------+----------+-----------+------------------
         0 |          1 |        4 |         4 |                0
         1 |          5 |        8 |         4 |                0
         2 |          9 |       12 |         4 |                0
         3 |         13 |       16 |         4 |                0
         4 |         17 |       18 |         2 |                0
(5 rows)

CREATE TABLE clustered_pg_fillfactor_floor(locator bytea);
INSERT INTO clustered_pg_fillfactor_floor(locator)
SELECT segment_map_allocate_locator('clustered_pg_fillfactor_floor'::regclass::oid, g, 1, 4, 1)
FROM generate_series(1,6) g;
SELECT count(*) AS fillfactor_floor_segment_count,
       sum(row_count) AS fillfactor_floor_rows
FROM segment_map_stats('clustered_pg_fillfactor_floor'::regclass::oid);
 fillfactor_floor_segment_count | fillfactor_floor_rows 
--------------------------------+-----------------------
                              6 |                     6
(1 row)

DROP TABLE clustered_pg_fillfactor_floor;
DROP TABLE clustered_pg_fillfactor_bounds;
CREATE TABLE clustered_pg_am_smoke(id bigint);
CREATE INDEX clustered_pg_am_smoke_idx
	ON clustered_pg_am_smoke USING clustered_pk_index (id)
		WITH (split_threshold=128, target_fillfactor=75, auto_repack_interval=30.0);
INSERT INTO clustered_pg_am_smoke(id)
SELECT generate_series(1,10000);
SELECT count(*) AS am_smoke_rows
FROM clustered_pg_am_smoke;
 am_smoke_rows 
---------------
         10000
(1 row)

SELECT count(*) AS am_smoke_segment_count,
       sum(row_count) AS am_smoke_segment_rows,
       max(major_key) AS am_smoke_max_major
FROM segment_map_stats('clustered_pg_am_smoke'::regclass::oid);
 am_smoke_segment_count | am_smoke_segment_rows | am_smoke_max_major 
------------------------+-----------------------+--------------------
                    105 |                 10000 |                104
(1 row)

DROP TABLE clustered_pg_am_smoke;
CREATE TABLE clustered_pg_am_scale_smoke(id bigint);
CREATE INDEX clustered_pg_am_scale_smoke_idx
	ON clustered_pg_am_scale_smoke USING clustered_pk_index (id)
		WITH (split_threshold=256, target_fillfactor=70, auto_repack_interval=30.0);
INSERT INTO clustered_pg_am_scale_smoke(id)
SELECT generate_series(1,50000);
SELECT count(*) AS am_scale_rows FROM clustered_pg_am_scale_smoke;
 am_scale_rows 
---------------
         50000
(1 row)

SELECT count(*) AS am_scale_segment_count,
       sum(row_count) AS am_scale_segment_rows,
       max(major_key) AS am_scale_max_major
FROM segment_map_stats('clustered_pg_am_scale_smoke'::regclass::oid);
 am_scale_segment_count | am_scale_segment_rows | am_scale_max_major 
------------------------+-----------------------+--------------------
                    280 |                 50000 |                279
(1 row)

DROP TABLE clustered_pg_am_scale_smoke;
CREATE TABLE clustered_pg_am_desc_smoke(id bigint);
CREATE INDEX clustered_pg_am_desc_smoke_idx
	ON clustered_pg_am_desc_smoke USING clustered_pk_index (id)
		WITH (split_threshold=64, target_fillfactor=60, auto_repack_interval=30.0);
INSERT INTO clustered_pg_am_desc_smoke(id)
SELECT generate_series(10000,1,-1);
SELECT count(*) AS am_desc_rows FROM clustered_pg_am_desc_smoke;
 am_desc_rows 
--------------
        10000
(1 row)

SELECT count(*) AS am_desc_segment_count,
       sum(row_count) AS am_desc_segment_rows,
       min(major_key) AS am_desc_min_major,
       max(major_key) AS am_desc_max_major
FROM segment_map_stats('clustered_pg_am_desc_smoke'::regclass::oid);
 am_desc_segment_count | am_desc_segment_rows | am_desc_min_major | am_desc_max_major 
-----------------------+----------------------+-------------------+-------------------
                   264 |                10000 |              -263 |                 0
(1 row)

DROP TABLE clustered_pg_am_desc_smoke;
CREATE TABLE clustered_pg_am_churn_smoke(id bigint);
CREATE INDEX clustered_pg_am_churn_smoke_idx
	ON clustered_pg_am_churn_smoke USING clustered_pk_index (id)
		WITH (split_threshold=32, target_fillfactor=80, auto_repack_interval=30.0);
INSERT INTO clustered_pg_am_churn_smoke(id)
SELECT generate_series(1,2000);
SELECT count(*) AS am_churn_initial_rows FROM clustered_pg_am_churn_smoke;
 am_churn_initial_rows 
-----------------------
                  2000
(1 row)

SELECT count(*) AS am_churn_initial_segment_count,
       max(major_key) AS am_churn_initial_max_major
FROM segment_map_stats('clustered_pg_am_churn_smoke'::regclass::oid);
 am_churn_initial_segment_count | am_churn_initial_max_major 
--------------------------------+----------------------------
                             80 |                         79
(1 row)

DELETE FROM clustered_pg_am_churn_smoke WHERE id % 2 = 0;
INSERT INTO clustered_pg_am_churn_smoke(id)
SELECT generate_series(1,2000);
SELECT count(*) AS am_churn_after_rows FROM clustered_pg_am_churn_smoke;
 am_churn_after_rows 
---------------------
                3000
(1 row)

SELECT count(*) AS am_churn_segment_count,
       sum(row_count) AS am_churn_segment_rows,
       max(major_key) AS am_churn_max_major
FROM segment_map_stats('clustered_pg_am_churn_smoke'::regclass::oid);
 am_churn_segment_count | am_churn_segment_rows | am_churn_max_major 
------------------------+-----------------------+--------------------
                     80 |                  4000 |                 79
(1 row)

DROP TABLE clustered_pg_am_churn_smoke;
SET enable_seqscan = off;
SET enable_bitmapscan = off;
CREATE TABLE clustered_pg_am_filter_query(id bigint);
CREATE INDEX clustered_pg_am_filter_query_idx
	ON clustered_pg_am_filter_query USING clustered_pk_index (id)
		WITH (split_threshold=64, target_fillfactor=90, auto_repack_interval=30.0);
INSERT INTO clustered_pg_am_filter_query(id)
SELECT generate_series(1,40);
SELECT id FROM clustered_pg_am_filter_query WHERE id = 17;
 id 
----
 17
(1 row)

SELECT array_agg(id ORDER BY id) AS am_filter_ids
FROM (SELECT id FROM clustered_pg_am_filter_query WHERE id BETWEEN 10 AND 20) q;
           am_filter_ids            
------------------------------------
 {10,11,12,13,14,15,16,17,18,19,20}
(1 row)

SELECT count(*) AS am_filter_count
FROM clustered_pg_am_filter_query WHERE id BETWEEN 5 AND 10;
 am_filter_count 
-----------------
               6
(1 row)

DROP TABLE clustered_pg_am_filter_query;
SET enable_mergejoin = on;
SET enable_hashjoin = off;
SET enable_nestloop = off;
SET enable_seqscan = off;
SET enable_bitmapscan = off;
CREATE TABLE clustered_pg_am_merge_fixture(id bigint);
CREATE TABLE clustered_pg_am_merge_fixture_b(id bigint);
CREATE INDEX clustered_pg_am_merge_fixture_a_idx
	ON clustered_pg_am_merge_fixture USING clustered_pk_index (id)
		WITH (split_threshold=32, target_fillfactor=85, auto_repack_interval=30.0);
CREATE INDEX clustered_pg_am_merge_fixture_b_idx
	ON clustered_pg_am_merge_fixture_b USING clustered_pk_index (id)
		WITH (split_threshold=32, target_fillfactor=85, auto_repack_interval=30.0);
INSERT INTO clustered_pg_am_merge_fixture(id)
SELECT generate_series(1,20);
INSERT INTO clustered_pg_am_merge_fixture_b(id)
SELECT generate_series(10,30);
SELECT count(*) AS am_merge_join_count
FROM clustered_pg_am_merge_fixture l
JOIN clustered_pg_am_merge_fixture_b r USING (id);
 am_merge_join_count 
---------------------
                  11
(1 row)

SELECT count(*) AS am_merge_join_filter_count
FROM clustered_pg_am_merge_fixture l
JOIN clustered_pg_am_merge_fixture_b r ON l.id = r.id
WHERE l.id BETWEEN 12 AND 16;
 am_merge_join_filter_count 
----------------------------
                          5
(1 row)

-- Exercise merge join mark/restore on repeated matches (duplication-heavy inner side)
CREATE TABLE clustered_pg_am_merge_markrestore(a bigint);
CREATE TABLE clustered_pg_am_merge_markrestore_b(a bigint);
CREATE INDEX clustered_pg_am_merge_markrestore_a_idx
	ON clustered_pg_am_merge_markrestore USING clustered_pk_index (a)
		WITH (split_threshold=32, target_fillfactor=85, auto_repack_interval=30.0);
CREATE INDEX clustered_pg_am_merge_markrestore_b_idx
	ON clustered_pg_am_merge_markrestore_b USING clustered_pk_index (a)
		WITH (split_threshold=32, target_fillfactor=85, auto_repack_interval=30.0);
INSERT INTO clustered_pg_am_merge_markrestore(a)
SELECT generate_series(1,10);
INSERT INTO clustered_pg_am_merge_markrestore_b(a) VALUES
	(1), (1), (2), (2), (2), (4), (6), (6);
SELECT a, count(*) AS matched_cnt
FROM clustered_pg_am_merge_markrestore l
JOIN clustered_pg_am_merge_markrestore_b r USING (a)
GROUP BY a
ORDER BY a;
 a | matched_cnt 
---+-------------
 1 |           2
 2 |           3
 4 |           1
 6 |           2
(4 rows)

SELECT count(*) AS am_merge_markrestore_row_count
FROM clustered_pg_am_merge_markrestore l
JOIN clustered_pg_am_merge_markrestore_b r USING (a)
WHERE l.a BETWEEN 2 AND 6;
 am_merge_markrestore_row_count 
--------------------------------
                              6
(1 row)

DROP TABLE clustered_pg_am_merge_markrestore;
DROP TABLE clustered_pg_am_merge_markrestore_b;
DROP TABLE clustered_pg_am_merge_fixture;
DROP TABLE clustered_pg_am_merge_fixture_b;
RESET enable_hashjoin;
RESET enable_nestloop;
RESET enable_mergejoin;
RESET enable_seqscan;
RESET enable_bitmapscan;
SELECT * FROM segment_map_stats('clustered_pg_fixture'::regclass::oid) ORDER BY major_key;
 major_key | minor_from | minor_to | row_count | split_generation 
-----------+------------+----------+-----------+------------------
         3 |          3 |        3 |         1 |                0
         4 |          1 |      100 |         7 |                0
(2 rows)

SELECT locator_lt(locator_pack(0,1), locator_pack(1,0)) as op_lt,
       locator_gt(locator_pack(1,0), locator_pack(0,1)) as op_gt,
       locator_eq(locator_pack(1,2), locator_pack(1,2)) as op_eq;
 op_lt | op_gt | op_eq 
-------+-------+-------
 t     | t     | t
(1 row)

DROP EXTENSION clustered_pg;
