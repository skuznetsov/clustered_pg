name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: PG ${{ matrix.pg_version }} - Build & Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg_version: [17, 18]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL ${{ matrix.pg_version }}
        run: |
          sudo apt-get install -y curl ca-certificates gnupg
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc \
            | sudo gpg --dearmor -o /usr/share/keyrings/pgdg.gpg
          echo "deb [signed-by=/usr/share/keyrings/pgdg.gpg] \
            http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" \
            | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y \
            postgresql-${{ matrix.pg_version }} \
            postgresql-server-dev-${{ matrix.pg_version }}

      - name: Build
        run: make PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config

      - name: Install
        run: sudo make install PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config

      - name: Start PostgreSQL
        run: |
          export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
          initdb -D /tmp/pgdata -A trust --no-locale
          pg_ctl -D /tmp/pgdata -l /tmp/pg.log -o "-k /tmp -p 5432" start

      - name: Regression tests
        run: make installcheck PGHOST=/tmp PGPORT=5432 PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config

      - name: Shell tests
        run: |
          export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
          make test-crash-recovery TMP_SELFTEST_ROOT=/tmp TEST_CRASH_PORT=5440
          make test-toast          TMP_SELFTEST_ROOT=/tmp TEST_TOAST_PORT=5441
          make test-alter-table    TMP_SELFTEST_ROOT=/tmp TEST_ALTER_PORT=5442
          make test-dump-restore   TMP_SELFTEST_ROOT=/tmp TEST_DUMP_PORT=5443
          make test-concurrent     TMP_SELFTEST_ROOT=/tmp TEST_CONCURRENT_PORT=5444

      - name: Upload regression diffs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: regression-diffs-pg${{ matrix.pg_version }}
          path: regression.diffs
          if-no-files-found: ignore

  pg-upgrade:
    name: pg_upgrade 17â†’18
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL 17 and 18
        run: |
          sudo apt-get install -y curl ca-certificates gnupg
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc \
            | sudo gpg --dearmor -o /usr/share/keyrings/pgdg.gpg
          echo "deb [signed-by=/usr/share/keyrings/pgdg.gpg] \
            http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" \
            | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y \
            postgresql-17 postgresql-server-dev-17 \
            postgresql-18 postgresql-server-dev-18

      - name: Build and install for both versions
        run: |
          make clean PG_CONFIG=/usr/lib/postgresql/17/bin/pg_config
          make PG_CONFIG=/usr/lib/postgresql/17/bin/pg_config
          sudo make install PG_CONFIG=/usr/lib/postgresql/17/bin/pg_config
          make clean PG_CONFIG=/usr/lib/postgresql/18/bin/pg_config
          make PG_CONFIG=/usr/lib/postgresql/18/bin/pg_config
          sudo make install PG_CONFIG=/usr/lib/postgresql/18/bin/pg_config

      - name: Run pg_upgrade test
        env:
          PG17_BINDIR: /usr/lib/postgresql/17/bin
          PG18_BINDIR: /usr/lib/postgresql/18/bin
        run: ./scripts/test_pg_upgrade.sh /tmp 5450 5451
